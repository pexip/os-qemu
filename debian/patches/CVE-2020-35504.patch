Description: CVE-2020-35504
Author: Abhijith PA <abhijith@debian.org>
---

--- qemu-3.1+dfsg.orig/hw/scsi/esp.c
+++ qemu-3.1+dfsg/hw/scsi/esp.c
@@ -252,6 +252,9 @@ static void esp_do_dma(ESPState *s)
         s->dma_memory_read(s->dma_opaque, &s->cmdbuf[s->cmdlen], len);
         return;
     }
+    if (!s->current_req) {
+        return;
+    }
     if (s->async_len == 0) {
         /* Defer until data is available.  */
         return;
@@ -265,6 +268,11 @@ static void esp_do_dma(ESPState *s)
     } else {
         s->dma_memory_write(s->dma_opaque, s->async_buf, len);
     }
+
+    if (!s->current_req) {
+        return;
+    }
+
     s->dma_left -= len;
     s->async_buf += len;
     s->async_len -= len;
